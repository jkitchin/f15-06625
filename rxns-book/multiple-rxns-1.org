#+STARTUP: showall
elisp:org-toggle-latex-overlays  elisp:org-toggle-pretty-entities

* Multiple reactions

** Stoichiometry in multiple reactions

-   When we have multiple reactions, e.g.

1. A \rightarrow 2B
2. B \rightarrow C

- We have a scenario where a species maybe consumed and/or generated by multiple reactions.

- We can define a reaction extent \xi_j for each reaction.
- Then for each species we can determine the change in moles from all the reactions as:

\(n_i = n_{i0} + \sum_j \alpha_{ij}\xi_j \)

where $\alpha_{ij}$ is the stoichiometric coefficient of species $i$ in reaction $j$.

Consider \xi_1=0.5 and \xi_2=0.25, and an initial moles of species B of 0.75 moles.

#+BEGIN_SRC python
N_B0 = 0.75
xi1 = 0.5
xi2 = 0.25

alpha_B1 = +2
alpha_B2 = -1

n_B = N_B0 + xi1 * alpha_B1 + xi2 * alpha_B2
print('There are now {} moles of B'.format(n_B))
#+END_SRC

#+RESULTS:
: There are now 1.5 moles of B

- Does that make sense?

- A slightly more compact way to write this using linear algebra.

#+BEGIN_SRC python
import numpy as np
N_B0 = 0.75
xi = [0.5, 0.25]
alpha = [2, -1]

n_B = N_B0 + np.dot(xi, alpha)
print('There are now {} moles of B'.format(n_B))
#+END_SRC

#+RESULTS:
: There are now 1.5 moles of B

** Rates for multiple reactions

-   When we have multiple reactions, e.g.

1. A \rightarrow 2B
2. B \rightarrow C

we have a scenario where a species maybe consumed and/or generated by multiple reactions.

- Each reaction will have its own reaction rate. We denote the rate of reaction $i$ as $r_i$.

- In this example, we might have $r_1 = k_1 C_A$, and $r_2 = k_2 C_B$.

- Then we have from reaction 1 that the rate of production of B is $r_{1,B} = 2 r_1$ and the rate of consumption in reaction two is $r_{2,B} = -r_2$.

- The net rate of production of species B is the sum of these two species specific rates.

\( r_B = 2 r_{1,B} + r_{2,b} \)

\( r_B = 2 r_1 - r_2 \)

- This is the expression we would use in a species mole balance. For example, in a constant volume batch reactor we would have:

\( \frac{dN_B}{dt} = V r_B \)

In this example you also need another mole balance on species A.

- Critical points
  + We need rate laws for each reaction
  + You derive the species rates using stoichiometry for each reaction
  + You add all the species rates together to get the net rate of reaction for the species

- Let us work out this example completely. Let us consider a constant volume batch reactor.

#+BEGIN_SRC python
import numpy as np
from scipy.integrate import odeint

k1 = 0.09 # 1/min  assuming both are first order
k2 = 0.2  # 1/min  r2 = k2 * Cb

CA0 = 2.5 # mol/L

def batch(C, t):
    Ca, Cb = C
    r1 = k1 * Ca
    r2 = k2 * Cb

    ra = -r1
    r1b = 2 * r1
    r2b = -r2
    rb = r1b + r2b

    dCadt = ra
    dCbdt = rb

    return [dCadt, dCbdt]

init = [CA0, 0.0] # initial conditions
tspan = np.linspace(0, 30) # min
sol = odeint(batch, init, tspan)

import matplotlib.pyplot as plt
plt.plot(tspan, sol)
plt.xlabel('Time (min)')
plt.ylabel('Conc (mol/L)')
plt.legend(['A','B'])

plt.savefig('images/batch-multiple.png')
#+END_SRC

#+RESULTS:

[[./images/batch-multiple.png]]

- You can see here that A continuously disappears. A is only consumed in the first reaction.

- Initially, B increases as it is produced by the first reaction. However, it begins to be consumed by reaction two, and eventually is completely consumed.
- If B was the desired product, you could maximize the yield by stopping the reaction after a short time.

** Reversible chemical reactions
   :PROPERTIES:
   :CUSTOM_ID: rate-reversible
   :ID:       c4411bb6-e33c-4ace-bb45-5c6a7a1e0e75
   :END:

- Reversible reactions are a special case of multiple reactions. We consider a forward and reverse reaction.

- For example, in the water gas shift reaction we could write the forward reaction as:

$CO + H_2O \rightarrow H_2 + CO_2$

and the reverse reaction as:

$H_2 + CO_2 \rightarrow CO + H_2O$

We write this as $CO + H_2O \rightleftharpoons H_2 + CO_2$.

- All reactions are to some extent reversible

\( \alpha A + b B + \cdots \rightleftharpoons q Q + s S + \cdots \)

- Thermodynamics defines the equilibrium distribution of reactants and products

\( \frac{a_Q^q a_S^s}{a_A^{\alpha} a_B^b} = K_{eq} =  e^{-\Delta G / RT} \)

where $\Delta G$ is the reaction Gibbs free energy defined by $\Delta G = \sum_j \alpha_j G_j$

- $a_A^{\alpha}$ is the activity of species $A$ raised to the \alpha power. It is common to use concentration instead of activity, but you must remember this implies ideal activity, and that the equilibrium constant may end up having units.

- Recall that activity is dimensionless

- We sometimes express activity in terms of concentration using activity coefficients
  + $a_j = \gamma_j C_j$
  + For ideal solutions, \gamma_j = 1

*** A brief worked example.

- The water gas shift reaction \(H_2O + CO \rightleftharpoons CO_2 + H_2 \) has a Gibbs reaction energy of -730 cal/mol at 1000K.

- If you start with equimolar amounts of water and carbon monoxide at a total pressure of 10 atm, what is the equilibrium composition of gases in mol/L?

- There is no change in the number of moles for the reaction, the temperature is constant, and thus the volume is constant.

- We essentially only need to find the equilibrium extent of reaction, and the problem is solved. We know in this case that $C_j = C_{j,0} + \alpha_j \xi$. At equilibrium,  we will have:

\( K = \frac{C_{C,eq} C_{D,eq}}{C_{A,eq} C_{B,eq}} = \frac{(C_{C,0} + \alpha_C \xi_{eq}) (C_{D,0} + \alpha_D \xi_{eq}) }{(C_{A,0} + \alpha_A \xi_{eq}) (C_{B,0} + \alpha_B \xi_{eq})} \)

- After simplification, we have:

\( K = \frac{\xi_{eq}^2}{(C_{A,0} - \xi_{eq})^2} \)

- So, we simply evaluate $K$ for the conditions, and then solve for $\xi_{eq}$.

- Let $C_{A0}$ = the concentration of A and B initially in the reactor. $C_{A0} = P_{A0} / (RT)$.

#+BEGIN_SRC python
import numpy as np

R = 1.987   # cal / mol / K
dG = -730   # cal / mol
T = 1000.0  # K

K = np.exp(-dG / R / T)
print('K = {0}'.format(K))

Pa0 = 5        # atm
R = 0.082057   # L atm / (mol K)
Ca0 = Pa0 / (R * T)

def func(xi):
    return K - (xi**2) / (Ca0 - xi)**2

from scipy.optimize import fsolve
guess = 0.05
xi_eq, = fsolve(func, guess)
print('xi_eq = ',xi_eq)

print('C_A = {0:1.4f} mol / L'.format(Ca0 - xi_eq))
print('C_C = {0:1.4f} mol / L'.format(xi_eq))
#+END_SRC

#+RESULTS:
: K = 1.44395809814
: ('xi_eq = ', 0.033257053151750419)
: C_A = 0.0277 mol / L
: C_C = 0.0333 mol / L


- An alternative formulation that uses the linear algebra notation follows. The advantage of this approach is that we do not need to derive the equation to solve, it is simply the definition of the equilibrium constant.  The code, on the other hand, is a little more verbose, while simultaneously being more explicit.

#+BEGIN_SRC python
import numpy as np

R = 1.987   # cal / mol / K
dG = -730   # cal / mol
T = 1000.0  # K

K = np.exp(-dG / R / T)
print('K = {0}'.format(K))

Pa0 = 5         # atm
R = 0.082057    # L atm / (mol K)
Ca0 = Pa0 / (R * T)

def func(xi):
    nu = np.array([-1, -1, 1, 1])  # stoichiometric coefficients
    C0 = np.array([Ca0, Ca0, 0.0, 0.0])  # initial concentrations
    # we use arrays so we can have element-wise multiplication
    C = C0 + nu * xi
    return K - np.prod(C**nu)

from scipy.optimize import fsolve
guess = 0.05
xi_eq, = fsolve(func, guess)

print('C_A = {0:1.4f} mol / L'.form at(Ca0 - xi_eq))
print('C_C = {0:1.4f} mol / L'.format(xi_eq))
#+END_SRC

#+RESULTS:

- We get the same result as before.

*** Temperature dependent equilibrium constants

- We defined the equilibrium constant as $K = e^{-\Delta G /(RT)}$.

- Thus, the equilibrium constant is temperature dependent because of the $T$ in the denominator of the exponential.

- It is /also/ temperature dependent because $\Delta G$ is temperature dependent.

- To incorporate the temperature dependence of the Gibbs free energy of a reaction, we need to compute the temperature dependence.

- The [[http://webbook.nist.gov/chemistry/][NIST Webbook]] provides data about a large number of compounds which can be used to compute reaction energies.

- Let us consider CO.

- At http://webbook.nist.gov/cgi/cbook.cgi?ID=C630080&Units=SI&Mask=1#Thermo-Gas you will find the data needed to compute the Gibbs free energy of CO at arbitrary temperature and standard pressure.
  + You will find the standard heat of formation and entropy,
  + coefficients of the Shomate polynomials which are used to calculate the enthalpy and entropy at non-standard temperatures.

- The Shomate polynomials are polynomials in $t = T/1000$.


\(H = H_{F, 298.15} + A t + B t^2/2 + C t^3/3 + D t^4/4 - E/t + F - H \)

\(S = A \ln(t) + B t + C t^2/2 + D t^3/3 - E/(2 t^2) + G\)

- With this information, we can calculate $G$ for CO at any temperature: \( G = H - T S \). If we have this information for all of the species, then we can compute the reaction energy at any temperature.

\( G_{rxn}(T) = \vec{\alpha} \cdot \vec{G_J}(T) \)

#+BEGIN_SRC python
import numpy as np

R = 8.314e-3 # kJ/mol/K

P = 10.0 # atm, this is the total pressure in the reactor
Po = 1.0 # atm, this is the standard state pressure

species = ['CO', 'H2O', 'CO2', 'H2']

# Heats of formation at 298.15 K

Hf298 = [-110.53,  # CO
         -241.826, # H2O
         -393.51,  # CO2
            0.0]   # H2

# Shomate parameters for each species in each column
# we write it this way to take less horizontal space
#      CO          H2O        CO2        H2
WB = [[25.56759,   30.092,    24.99735,  33.066178],     # A
      [6.09613,    6.832514,  55.18696, -11.363417],     # B
      [4.054656,   6.793435, -33.69137,  11.432816],     # C
      [-2.671301, -2.53448,   7.948387, -2.772874],      # D
      [0.131021,   0.082139, -0.136638, -0.158558],      # E
      [-118.0089, -250.881,  -403.6075, -9.980797],      # F
      [227.3665,   223.3967,  228.2431,  172.707974],    # G
      [-110.5271, -241.8264, -393.5224,  0.0]]           # H

# transpose the array so it has the right dimensions
WB = np.array(WB).T

def G_rxn(T):
    # Shomate equations
    t = T/1000
    T_H = np.array([t,  t**2 / 2.0, t**3 / 3.0,
                    t**4 / 4.0, -1.0 / t, 1.0, 0.0, -1.0])
    T_S = np.array([np.log(t), t,  t**2 / 2.0,  t**3 / 3.0,
                    -1.0 / (2.0 * t**2), 0.0, 1.0, 0.0])

    H = np.dot(WB, T_H)          # (H - H_298.15) kJ/mol
    S = np.dot(WB, T_S / 1000.0) # absolute entropy kJ/mol/K

    Gjo = Hf298 + H - T * S      # Gibbs energy of each component at 1000 K

    nu = np.array([-1, -1, 1, 1])
    Grxn = np.dot(nu, Gjo)
    return Grxn

print('Reaction energy at 1000K = {0} kJ/mol'.format(G_rxn(1000)))

# print energy in different units
import quantities as u

e500 =  (G_rxn(500.0) * 1000 * u.J / u.mol ).rescale(u.cal / u.mol)
e1000 = (G_rxn(1000.0) * 1000 * u.J / u.mol ).rescale(u.cal / u.mol)

print('At 1000 K the reaction energy is {0}'.format(e1000))
print('At 500 K the reaction energy is {0}'.format(e500))
#+END_SRC

#+RESULTS:
: Reaction energy at 1000K = -3.00803816667 kJ/mol
: At 1000 K the reaction energy is -718.938376354 cal/mol
: At 500 K the reaction energy is -4890.09976584 cal/mol

- You can see here that lower temperatures make the reaction much more exothermic.
- The equilibrium constant would be considerably larger, and the products more favored at the lower temperature.

*** Another view of chemical equilibrium

- The composition at chemical equilibrium is the one that minimizes the Gibbs free energy of the mixture.

- We can use the data for computing the Gibbs free energy of pure components to illustrate this.

- We have to compute the Gibbs free energy of a species in the mixture, which is easy if we can assume an ideal mixture. Then we have

$G_j =  G_{j0} + R T \log(x_j  P / P_0)$.

- Here we will show that there is a reaction extent that minimizes the Gibbs free energy of the mixture.

#+BEGIN_SRC python
import numpy as np
T = 1000      # K
R = 8.314e-3  # kJ/mol/K
R_ = 0.082057 # L * atm / mol / K

P = 10.0 # atm, this is the total pressure in the reactor
Po = 1.0 # atm, this is the standard state pressure

species = ['CO', 'H2O', 'CO2', 'H2']
nu = np.array([-1, -1, 1, 1]) # stoichiometric coefficients

# Heats of formation at 298.15 K
Hf298 = [
    -110.53,  # CO
    -241.826, # H2O
    -393.51,  # CO2
       0.0]   # H2

# Shomate parameters for each species
#      CO        H2O     CO2       H2
WB = [[25.56759, 30.092, 24.99735, 33.066178],    # A
      [6.09613, 6.832514, 55.18696, -11.363417],  # B
      [4.054656, 6.793435, -33.69137, 11.432816], # C
      [-2.671301, -2.53448, 7.948387, -2.772874], # D
      [0.131021, 0.082139, -0.136638, -0.158558], # E
      [-118.0089, -250.881, -403.6075, -9.980797],# F
      [227.3665, 223.3967, 228.2431, 172.707974], # G
      [-110.5271, -241.8264, -393.5224, 0.0]]     # H

WB = np.array(WB).T

# Shomate equations
t = T / 1000
T_H = np.array([t,  t**2 / 2.0, t**3 / 3.0, t**4 / 4.0,
                -1.0 / t, 1.0, 0.0, -1.0])
T_S = np.array([np.log(t), t,  t**2 / 2.0,  t**3 / 3.0,
                -1.0 / (2.0 * t**2), 0.0, 1.0, 0.0])

H = np.dot(WB, T_H)          # (H - H_298.15) kJ/mol
S = np.dot(WB, T_S / 1000.0) # absolute entropy kJ/mol/K

Gjo = Hf298 + H - T * S      # Gibbs energy of each component at 1000 K

C0 = np.array([5.0, 5.0, 0.0, 0.0]) / R_ / T # initial concentrations

@np.vectorize
def G_tot(xi):

    C = C0 + xi * nu # change in moles from reaction extent

    x = C / C.sum()  # mole fractions

    # Species gibbs energies in mixture
    G = Gjo + R * T * np.log(x * P / Po)
    return  np.dot(C, G)


XI = np.linspace(0, max(C0))

import matplotlib.pyplot as plt
plt.plot(XI, G_tot(XI))
plt.xlabel('$\\xi$ (mol)')
plt.ylabel('$G$ (kJ/mol)')
plt.savefig('images/equilibrium-G.png')
plt.show()
#+END_SRC

#+RESULTS:

[[./images/equilibrium-G.png]]

You have to be careful not to exceed the maximum \xi. You can see there is a minimum in the Gibbs energy of the mixture, and it corresponds to the value we saw previously.

We could find the minimum numerically using optimization algorithms. For completeness we show that here. see pydoc:scipy.optimize.fmin

#+BEGIN_SRC python
import numpy as np
T = 1000      # K
R = 8.314e-3  # kJ/mol/K
R_ = 0.082057 # L * atm / mol / K

P = 10.0 # atm, this is the total pressure in the reactor
Po = 1.0 # atm, this is the standard state pressure

species = ['CO', 'H2O', 'CO2', 'H2']
nu = np.array([-1, -1, 1, 1]) # stoichiometric coefficients

# Heats of formation at 298.15 K
Hf298 = [
    -110.53,  # CO
    -241.826, # H2O
    -393.51,  # CO2
       0.0]   # H2

# Shomate parameters for each species
#      CO        H2O     CO2       H2
WB = [[25.56759, 30.092, 24.99735, 33.066178],    # A
      [6.09613, 6.832514, 55.18696, -11.363417],  # B
      [4.054656, 6.793435, -33.69137, 11.432816], # C
      [-2.671301, -2.53448, 7.948387, -2.772874], # D
      [0.131021, 0.082139, -0.136638, -0.158558], # E
      [-118.0089, -250.881, -403.6075, -9.980797],# F
      [227.3665, 223.3967, 228.2431, 172.707974], # G
      [-110.5271, -241.8264, -393.5224, 0.0]]     # H

WB = np.array(WB).T

# Shomate equations
t = T/1000
T_H = np.array([t,  t**2 / 2.0, t**3 / 3.0,
                t**4 / 4.0, -1.0 / t, 1.0, 0.0, -1.0])
T_S = np.array([np.log(t), t,  t**2 / 2.0,
                t**3 / 3.0, -1.0 / (2.0 * t**2),
                0.0, 1.0, 0.0])

H = np.dot(WB, T_H)          # (H - H_298.15) kJ/mol
S = np.dot(WB, T_S / 1000.0) # absolute entropy kJ/mol/K

Gjo = Hf298 + H - T * S      # Gibbs energy of each component at 1000 K

C0 = np.array([5.0, 5.0, 0.0, 0.0]) / R_ / T # initial concentrations

@np.vectorize
def G_tot(xi):

    C = C0 + xi * nu # change in moles from reaction extent

    x = C / C.sum()  # mole fractions

    # Species gibbs energies in mixture
    G = Gjo + R * T * np.log(x * P / Po)
    return  np.dot(C, G)

from scipy.optimize import fmin

xi_guess = 0.03
sol, = fmin(G_tot, xi_guess)
print('The Gibbs free energy is minimized at xi = {0} mol/L'.format(sol))
#+END_SRC

#+RESULTS:
: Optimization terminated successfully.
:          Current function value: -46.204283
:          Iterations: 6
:          Function evaluations: 12
: The Gibbs free energy is minimized at xi = 0.0331875 mol/L

*** Gibbs energy constrained minimization and the NIST webbook	   :optional:

- We used the NIST webbook to compute a temperature dependent Gibbs energy of reaction, and then used a reaction extent variable to compute the equilibrium concentrations of each species for the water gas shift reaction.

- Here we look at the direct minimization of the Gibbs free energy of the species, with no assumptions about stoichiometry of reactions. We only apply the constraint of conservation of atoms. We use the NIST Webbook to provide the data for the Gibbs energy of each species.

- As a reminder we consider equilibrium between the species $CO$, $H_2O$, $CO_2$ and $H_2$, at 1000K, and 10 atm total pressure with an initial equimolar molar flow rate of $CO$ and $H_2O$.

#+BEGIN_SRC python :session
import numpy as np

T = 1000  # K
R = 8.314e-3 # kJ/mol/K

P = 10.0 # atm, this is the total pressure in the reactor
Po = 1.0 # atm, this is the standard state pressure
#+END_SRC

#+RESULTS:

We are going to store all the data and calculations in vectors, so we need to assign each position in the vector to a species. Here are the definitions we use in this work.

#+BEGIN_EXAMPLE
1  CO
2  H2O
3  CO2
4  H2
#+END_EXAMPLE

#+BEGIN_SRC python :session
species = ['CO', 'H2O', 'CO2', 'H2']

# Heats of formation at 298.15 K

Hf298 = [
    -110.53,  # CO
    -241.826, # H2O
    -393.51,  # CO2
       0.0]   # H2


# Shomate parameters for each species
#      CO        H2O     CO2       H2
WB = [[25.56759, 30.092, 24.99735, 33.066178],    # A
      [6.09613, 6.832514, 55.18696, -11.363417],  # B
      [4.054656, 6.793435, -33.69137, 11.432816], # C
      [-2.671301, -2.53448, 7.948387, -2.772874], # D
      [0.131021, 0.082139, -0.136638, -0.158558], # E
      [-118.0089, -250.881, -403.6075, -9.980797],# F
      [227.3665, 223.3967, 228.2431, 172.707974], # G
      [-110.5271, -241.8264, -393.5224, 0.0]]     # H

WB = np.array(WB).T

# Shomate equations
t = T/1000
T_H = np.array([t,  t**2 / 2.0, t**3 / 3.0, t**4 / 4.0,
                -1.0 / t, 1.0, 0.0, -1.0])
T_S = np.array([np.log(t), t,  t**2 / 2.0,  t**3 / 3.0,
                -1.0 / (2.0 * t**2), 0.0, 1.0, 0.0])

H = np.dot(WB, T_H)        # (H - H_298.15) kJ/mol
S = np.dot(WB, T_S/1000.0) # absolute entropy kJ/mol/K

Gjo = Hf298 + H - T*S      # Gibbs energy of each component at 1000 K
#+END_SRC

#+RESULTS:

- Now, construct the Gibbs free energy function, accounting for the change in activity due to concentration changes (ideal mixing).

#+BEGIN_SRC python :session
def func(nj):
    nj = np.array(nj)
    Enj = np.sum(nj);
    Gj =  Gjo / (R * T) + np.log(nj / Enj * P / Po)
    return np.dot(nj, Gj)
#+END_SRC

#+RESULTS:

- We impose the constraint that all atoms are conserved from the initial conditions to the equilibrium distribution of species. These constraints are in the form of $A_{eq} n = b_{eq}$, where $n$ is the vector of mole numbers for each species.

#+BEGIN_SRC python :session
Aeq = np.array([[ 1,    0,    1,    0],  # C balance
                [ 1,    1,    2,    0],  # O balance
                [ 0,    2,    0,    2]]) # H balance

# equimolar feed of 1 mol H2O and 1 mol CO
beq = np.array([1,  # mol C fed
                2,  # mol O fed
                2]) # mol H fed

def ec1(nj):
    'conservation of atoms constraint'
    return np.dot(Aeq, nj) - beq
#+END_SRC

#+RESULTS:

- Now we are ready to solve the problem.

#+BEGIN_SRC python :session
from scipy.optimize import fmin_slsqp

n0 = [0.5, 0.5, 0.5, 0.5]  # initial guesses
N = fmin_slsqp(func, n0, f_eqcons=ec1)
print(N)
#+END_SRC

#+RESULTS:
:
: >>> >>> Optimization terminated successfully.    (Exit mode 0)
:             Current function value: -91.204832308
:             Iterations: 2
:             Function evaluations: 13
:             Gradient evaluations: 2
: [ 0.45502309  0.45502309  0.54497691  0.54497691]

**** Compute mole fractions and partial pressures

- The pressures here are in good agreement with the pressures found by other methods. The minor disagreement (in the third or fourth decimal place) is likely due to convergence tolerances in the different algorithms used.

#+BEGIN_SRC python :session
yj = N / np.sum(N)
Pj = yj * P

for s, y, p in zip(species, yj, Pj):
    print('{0:10s}: {1:1.2f} {2:1.2f}'.format(s, y, p))
#+END_SRC

#+RESULTS:
:
: >>> >>> ... ... CO        : 0.23 2.28
: H2O       : 0.23 2.28
: CO2       : 0.27 2.72
: H2        : 0.27 2.72

**** Computing equilibrium constants

- We can compute the equilibrium constant for the reaction $CO + H_2O \rightleftharpoons CO_2 + H_2$.

- Compared to the value of K = 1.44 we found previously, the agreement is excellent.

- Note, that to define an equilibrium constant it is necessary to specify a reaction, even though it is not necessary to even consider a reaction to obtain the equilibrium distribution of species!

#+BEGIN_SRC python :session
nuj = np.array([-1, -1, 1, 1])  # stoichiometric coefficients of the reaction
K = np.prod(yj**nuj)
print(K)
#+END_SRC

#+RESULTS:
:
: >>> 1.43446295961

*** Finding equilibrium composition by direct minimization of Gibbs free energy on mole numbers :optional:

Adapted from problem 4.5 in Cutlip and Shacham
- Ethane and steam are fed to a steam cracker at a total pressure of 1 atm and at 1000K at a ratio of 4 mol H_2O to 1 mol ethane. Estimate the equilibrium distribution of products (CH_{4}, C_{2}H_{4}, C_{2}H_{2}, CO_{2}, CO, O_{2}, H_{2}, H_{2}O, and C_{2}H_{6}).

- Solution method: We will construct a Gibbs energy function for the mixture, and obtain the equilibrium composition by minimization of the function subject to elemental mass balance constraints.

#+BEGIN_SRC python :session
import numpy as np

R = 0.00198588 # kcal/mol/K
T = 1000 # K

species = ['CH4', 'C2H4', 'C2H2', 'CO2', 'CO', 'O2', 'H2', 'H2O', 'C2H6']

# $G_^\circ for each species. These are the heats of formation for each
# species.
Gjo = np.array([4.61, 28.249, 40.604, -94.61, -47.942, 0, 0, -46.03, 26.13]) # kcal/mol
#+END_SRC

#+RESULTS:

**** The Gibbs energy of a mixture

- We start with $G=\sum\limits_j n_j \mu_j$.
- Recalling that we define $\mu_j = G_j^\circ + RT \ln a_j$, and in the ideal gas limit, $a_j = y_j P/P^\circ$, and that $y_j = \frac{n_j}{\sum n_j}$.

- Since in this problem, P = 1 atm, this leads to the function $\frac{G}{RT} = \sum\limits_{j=1}^n n_j\left(\frac{G_j^\circ}{RT} + \ln \frac{n_j}{\sum n_j}\right)$.

#+BEGIN_SRC python :session
import numpy as np

def func(nj):
    nj = np.array(nj)
    Enj = np.sum(nj)
    G = np.sum(nj * (Gjo / R / T + np.log(nj / Enj)))
    return G
#+END_SRC

#+RESULTS:

**** Linear equality constraints for atomic mass conservation

- The total number of each type of atom must be the same as what entered the reactor. These form equality constraints on the equilibrium composition.

- We express these constraints as: $A_{eq} n = b$ where $n$ is a vector of the moles of each species present in the mixture.

#+BEGIN_SRC python :session
Aeq = np.array([[0,   0,    0,   2,   1,  2,  0,  1,   0],      # oxygen balance
                [4,   4,    2,   0,   0,  0,  2,  2,   6],      # hydrogen balance
                [1,   2,    2,   1,   1,  0,  0,  0,   2]])     # carbon balance

# the incoming feed was 4 mol H2O and 1 mol ethane
beq = np.array([4,  # moles of oxygen atoms coming in
                14, # moles of hydrogen atoms coming in
                2]) # moles of carbon atoms coming in

def ec1(n):
    'equality constraint'
    return np.dot(Aeq, n) - beq

#+END_SRC

#+RESULTS:

- Now we solve the problem.

#+BEGIN_SRC python :session
# initial guess suggested in the example
n0 = [1e-3, 1e-3, 1e-3, 0.993, 1.0, 1e-4, 5.992, 1.0, 1e-3]

from scipy.optimize import fmin_slsqp

X = fmin_slsqp(func, n0, f_eqcons=ec1, iter=300, acc=1e-12)

for s,x in zip(species, X):
    print('{0:10s} {1:1.4g}'.format(s, x))

# check that constraints were met
print(np.dot(Aeq, X) - beq)
print(np.all( np.abs( np.dot(Aeq, X) - beq) < 1e-12))
#+END_SRC

#+RESULTS:
#+begin_example

>>> >>> >>> >>> Optimization terminated successfully.    (Exit mode 0)
            Current function value: -104.403947663
            Iterations: 217
            Function evaluations: 2937
            Gradient evaluations: 217
>>> ... ... CH4        0.06694
C2H4       8.108e-08
C2H2       5.174e-08
CO2        0.5441
CO         1.389
O2         1.222e-14
H2         5.343
H2O        1.523
C2H6       8.44e-08
... [ -1.66977543e-13   1.77635684e-15   4.44089210e-16]
True
#+end_example

- I found it necessary to tighten the accuracy parameter to get pretty good matches to the solutions found in Matlab. It was also necessary to increase the number of iterations. Even still, not all of the numbers match well, especially the very small numbers. You can, however, see that the constraints were satisfied pretty well.


- Interestingly there is a distribution of products!

- That is interesting because only steam and ethane enter the reactor, but a small fraction of methane is formed!

- The main product is hydrogen. The stoichiometry of steam reforming is ideally $C_2H_6 + 4H_2O \rightarrow 2CO_2 + 7 H2$. Even though nearly all the ethane is consumed, we do not get the full yield of hydrogen.

- It appears that another equilibrium, one between CO, CO_2, H_{2}O and H_2, may be limiting that, since the rest of the hydrogen is largely in the water.

- It is also of great importance that we have not said anything about reactions, i.e. how these products were formed.

- The water gas shift reaction is: $CO + H_2O \rightleftharpoons CO_2 + H_2$. We can compute the Gibbs free energy of the reaction from the heats of formation of each species. Assuming these are the formation energies at 1000K, this is the reaction free energy at 1000K.

#+BEGIN_SRC python :session
G_wgs = Gjo[3] + Gjo[6] - Gjo[4] - Gjo[7]
print(G_wgs)

K = np.exp(-G_wgs / (R*T))
print(K)
#+END_SRC

#+RESULTS:
:
: -0.638
: >>> >>> 1.37887528109

**** Equilibrium constant based on mole numbers

- One normally uses activities to define the equilibrium constant. Since there are the same number of moles on each side of the reaction all factors that convert mole numbers to activity, concentration or pressure cancel, so we simply consider the ratio of mole numbers here.

#+BEGIN_SRC python :session
print((X[3] * X[6]) / (X[4] * X[7]))
#+END_SRC

#+RESULTS:
: 1.37450039394

- This is close, but not exactly the same as the equilibrium constant computed above. They should be exactly the same, and the difference is due to convergence errors in the solution to the problem.

- Clearly, there is an equilibrium between these species that prevents the complete reaction of steam reforming.

**** Summary

- This is an appealing way to minimize the Gibbs energy of a mixture. No assumptions about reactions are necessary, and the constraints are easy to identify. The Gibbs energy function is especially easy to code.


*** Equilibria with multiple reactions

- We use the same fundamental approaches to solving equilibrium problems when there are multiple reactions
 + In fact, we do not need to consider reactions at all if we know the Gibbs free energies of each species

- Let us consider this set of reactions, where all species are in the gas phase. Assume we start with equimolar amounts of A and B, and a total pressure of 2.5 atm at 400 K.

1. \(A + B \rightleftharpoons C\) with K_1 = 108
2. \(A + B \rightleftharpoons D \) with K_2 = 284

We want to know what the equilibrium composition for these reactions are.

We have two equations:
\(K_1 = \frac{a_C}{a_A a_B} \)

and

\(K_2 = \frac{a_D}{a_A a_B} \)

- We know the activity of a gas species is $a_j = P_j / 1 atm$ or equivalently in mole fraction: $a_j = x_j P / 1 atm$.

- We define reaction extents for each reaction: \xi_1 and \xi_2

- Then:
\begin{align}
n_A = n_{A0} - \xi_1 - \xi_2 \\
n_B = n_{B0} - \xi_1 - \xi_2 \\
n_C = \xi_1  \\
n_D = \xi_2 \\
n_{total} = n_{t0} - \xi_1 - \xi_2
\end{align}

- We can define mole fractions from these equations which allow us to express the equilibrium equations in two unknowns.

- It is convenient to normalize all equations by $n_{t0}$, which leads to these definitions for the mole fractions:

\begin{align}
y_A = \frac{y_{A0} - \xi_1' - \xi_2'}{1 - \xi_1' - \xi_2'} \\
y_B = \frac{y_{B0} - \xi_1' - \xi_2'}{1 - \xi_1' - \xi_2'} \\
y_C = \frac{\xi_1'}{1 - \xi_1' - \xi_2'} \\
y_D = \frac{\xi_2'}{1 - \xi_1' - \xi_2'} \\
\end{align}

- These are plugged into the activity $a_j = y_j P / 1 atm$.

Here is the code we use to solve this problem.

#+BEGIN_SRC python
ya0 = 0.5 # initial mole fraction of A
yb0 = 0.5 # initial mole fraction of B
P = 2.5   # initial pressure in atm

def xj(extent):
    'convenience function to calculate mole fractions'
    ext1, ext2 = extent
    ya = (ya0 - ext1 - ext2) / (1.0 - ext1 - ext2)
    yb = (yb0 - ext1 - ext2) / (1.0 - ext1 - ext2)
    yc = (ext1) / (1.0 - ext1 - ext2)
    yd = (ext2) / (1.0 - ext1 - ext2)
    return [ya, yb, yc, yd]

def func(extent):
    'zeros function for fsolve'
    ya, yb, yc, yd = xj(extent)

    eq1 = 108.0 - (yc * P)/(ya * P * yb * P)
    eq2 = 284.0 - (yd * P)/(ya * P * yb * P)

    return [eq1, eq2]

from scipy.optimize import fsolve

guess = [0.1, 0.39]
sol = fsolve(func, guess)

print('The reaction extents are:\n',sol)

print('The mole fractions are: \n',xj(sol))
#+END_SRC

#+RESULTS:
: The reaction extents are:
: [ 0.13335692  0.35067931]
: The mole fractions are:
: [0.030939713802784111, 0.030939713802784111, 0.25846179035362588, 0.6796587820408061]

- There are significant amounts of each product

- Note that other initial guesses give unphysical solutions, i.e. negative mole fractions.

- Also note that this solution applies to a /constant total pressure/ which means in this case the volume must be changing since there is a change in the number of moles
  + You would get a different result in a constant volume reactor where the total pressure changes

- There is a constraint on the two reaction extents.
  + since no mole fraction can be negative, $\xi_1' + \xi_2' \le y_{A0}$
  + Other solutions violate this constraint
  + You may have to use constrained optimization to find physical solutions
